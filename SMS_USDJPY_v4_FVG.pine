//@version=6
indicator("SMS Pro USDJPY v4", shorttitle="SMS-JPY", overlay=true, max_lines_count=100, max_labels_count=200, max_boxes_count=100)

// ============================================================================
// CONFIGURACION PRINCIPAL - OPTIMIZADO PARA USD/JPY - v4 CON FVG ACTIVO
// ============================================================================

// EMAs
emaFastLen = input.int(9, "EMA Rapida", minval=1, group="EMAs")
emaSlowLen = input.int(21, "EMA Lenta", minval=1, group="EMAs")
ema200Len = input.int(200, "EMA 200", minval=50, group="EMAs")
showEMA200 = input.bool(true, "Mostrar EMA 200", group="EMAs")

// Market Structure
swingLen = input.int(5, "Swing Lookback", minval=2, maxval=20, group="Structure")
showBOS = input.bool(true, "Mostrar BOS", group="Structure")
showCHOCH = input.bool(true, "Mostrar CHoCH", group="Structure")

// Order Blocks
showOB = input.bool(true, "Mostrar Order Blocks", group="Order Blocks")
maxOB = input.int(3, "Max Order Blocks visibles", minval=1, maxval=10, group="Order Blocks")

// FVG - MEJORADO: Ahora activo como confluencia
showFVG = input.bool(true, "Mostrar FVG", group="FVG")
fvgMinSize = input.float(0.03, "Tamano minimo FVG %", minval=0.01, maxval=0.5, group="FVG")
maxFVG = input.int(3, "Max FVG visibles", minval=1, maxval=10, group="FVG")
useFVGConfluence = input.bool(true, "Usar FVG como Confluencia", group="FVG", tooltip="Suma +1 confluencia cuando precio entra en FVG")

// Liquidez - Filtros para sweeps
showSweeps = input.bool(true, "Mostrar Liquidity Sweeps", group="Liquidez")
showEQHL = input.bool(false, "Mostrar Equal H/L", group="Liquidez")
eqhLookback = input.int(15, "Lookback", minval=5, maxval=50, group="Liquidez")
filterSweeps = input.bool(true, "Filtrar Sweeps (solo zonas clave)", group="Liquidez")
sweepMinATR = input.float(0.3, "Sweep minimo (x ATR)", minval=0.1, maxval=1.0, group="Liquidez")

// Kill Zones - Incluye TOKYO para pares JPY
showKillZones = input.bool(true, "Mostrar Kill Zones", group="Kill Zones")
onlyTradeKZ = input.bool(false, "Solo senales en Kill Zone", group="Kill Zones")
showTokyoKZ = input.bool(true, "Mostrar Tokyo KZ", group="Kill Zones")

// Fibonacci
showFib = input.bool(true, "Mostrar Fib 50%", group="Fibonacci")
fibLookback = input.int(30, "Lookback", minval=10, maxval=100, group="Fibonacci")

// Senales - ACTUALIZADO: Ahora maximo 8 confluencias
showSignals = input.bool(true, "Mostrar Senales", group="Senales")
minConfluence = input.int(3, "Minimo Confluencias", minval=2, maxval=7, group="Senales")
showLabels = input.bool(true, "Mostrar Labels SL/TP", group="Senales")

// ATR
atrLen = input.int(14, "Periodo ATR", minval=5, maxval=50, group="ATR")
atrMult = input.float(1.2, "Multiplicador SL", minval=0.5, maxval=3.0, group="ATR")
rrRatio = input.float(2.0, "Ratio Riesgo:Beneficio", minval=1.0, maxval=5.0, group="ATR")
useOBforSL = input.bool(true, "Usar Order Block para SL", group="ATR")

// SPREAD - Configuracion de spread para JPY
spreadPips = input.float(1.5, "Spread estimado (pips)", minval=0.5, maxval=5.0, group="Spread", tooltip="USD/JPY tipico: 1.0-2.0 pips")
addSpreadToSL = input.bool(true, "Agregar spread al SL", group="Spread")
spreadBuffer = input.float(0.5, "Buffer adicional (pips)", minval=0.0, maxval=2.0, group="Spread")

// ALERTAS
enableAlerts = input.bool(true, "Habilitar Alertas", group="Alertas")
alertOnSweeps = input.bool(false, "Alertas de Sweeps", group="Alertas", tooltip="Desactivado por defecto para evitar ruido")
alertOnCHoCH = input.bool(true, "Alertas de CHoCH", group="Alertas")
alertOnBOS = input.bool(false, "Alertas de BOS", group="Alertas")

// Panel
showPanel = input.bool(true, "Mostrar Panel Info", group="Visual")

// ============================================================================
// COLORES
// ============================================================================

bullColor = color.rgb(0, 230, 118)
bearColor = color.rgb(255, 82, 82)
bosColor = color.rgb(0, 188, 212)
chochColor = color.rgb(255, 152, 0)
obBullColor = color.new(color.rgb(38, 166, 154), 80)
obBearColor = color.new(color.rgb(239, 83, 80), 80)
fvgBullColor = color.new(color.rgb(0, 150, 255), 80)      // Azul para FVG alcista
fvgBearColor = color.new(color.rgb(255, 150, 0), 80)      // Naranja para FVG bajista
tokyoColor = color.new(color.rgb(255, 100, 200), 93)      // Rosa para Tokyo

// ============================================================================
// CALCULOS BASE
// ============================================================================

emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)
ema200 = ta.ema(close, ema200Len)
atrValue = ta.atr(atrLen)

// Spread en precio (USD/JPY: pips * 0.01)
pipValue = 0.01  // JPY pairs: 1 pip = 0.01
totalSpreadBuffer = addSpreadToSL ? (spreadPips + spreadBuffer) * pipValue : 0

trendUp = emaFast > emaSlow
trendDown = emaFast < emaSlow
htfTrendUp = close > ema200
htfTrendDown = close < ema200

bodySize = math.abs(close - open)
candleRange = high - low
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
isBullCandle = close > open
isBearCandle = close < open

// ============================================================================
// KILL ZONES - INCLUYE TOKYO PARA JPY
// ============================================================================

utcHour = hour(time, "UTC")
estHour = (utcHour - 5 + 24) % 24

inLondonKZ = estHour >= 2 and estHour < 5
inNYKZ = estHour >= 7 and estHour < 10
inNYOverlap = estHour >= 8 and estHour < 11
inTokyoKZ = estHour >= 19 or estHour < 2  // Tokyo session: 19:00-02:00 EST
inAnyKZ = inLondonKZ or inNYKZ or inNYOverlap or (showTokyoKZ and inTokyoKZ)

// Background color
color kzBgColor = na
if showKillZones
    if inTokyoKZ and showTokyoKZ
        kzBgColor := tokyoColor
    else if inLondonKZ
        kzBgColor := color.new(color.blue, 93)
    else if inNYKZ or inNYOverlap
        kzBgColor := color.new(color.green, 93)
bgcolor(kzBgColor)

kzName = inTokyoKZ and showTokyoKZ ? "TOKYO" : inLondonKZ ? "LONDON" : inNYKZ ? "NEW YORK" : inNYOverlap ? "NY-OVERLAP" : "FUERA KZ"

// ============================================================================
// MARKET STRUCTURE
// ============================================================================

swingHigh = ta.pivothigh(high, swingLen, swingLen)
swingLow = ta.pivotlow(low, swingLen, swingLen)

var float lastSwingHigh = na
var float lastSwingLow = na
var int trendDir = 0

if not na(swingHigh)
    lastSwingHigh := swingHigh
if not na(swingLow)
    lastSwingLow := swingLow

crossOverHigh = ta.crossover(close, nz(lastSwingHigh, high))
crossUnderLow = ta.crossunder(close, nz(lastSwingLow, low))

bos_bull = not na(lastSwingHigh) and crossOverHigh and trendDir == 1
bos_bear = not na(lastSwingLow) and crossUnderLow and trendDir == -1
choch_bull = not na(lastSwingHigh) and crossOverHigh and trendDir == -1
choch_bear = not na(lastSwingLow) and crossUnderLow and trendDir == 1

if choch_bull or bos_bull
    trendDir := 1
if choch_bear or bos_bear
    trendDir := -1

bos_bull_confirmed = showBOS and bos_bull and barstate.isconfirmed
bos_bear_confirmed = showBOS and bos_bear and barstate.isconfirmed
choch_bull_confirmed = showCHOCH and choch_bull and barstate.isconfirmed
choch_bear_confirmed = showCHOCH and choch_bear and barstate.isconfirmed

if bos_bull_confirmed
    label.new(bar_index, low, "BOS", style=label.style_label_up, color=bosColor, textcolor=color.white, size=size.tiny)
if bos_bear_confirmed
    label.new(bar_index, high, "BOS", style=label.style_label_down, color=bosColor, textcolor=color.white, size=size.tiny)
if choch_bull_confirmed
    label.new(bar_index, low, "CHoCH", style=label.style_label_up, color=chochColor, textcolor=color.white, size=size.small)
if choch_bear_confirmed
    label.new(bar_index, high, "CHoCH", style=label.style_label_down, color=chochColor, textcolor=color.white, size=size.small)

// ============================================================================
// ORDER BLOCKS
// ============================================================================

var array<box> bullOBBoxes = array.new<box>()
var array<box> bearOBBoxes = array.new<box>()
var array<float> bullOBTops = array.new<float>()
var array<float> bullOBBottoms = array.new<float>()
var array<float> bearOBTops = array.new<float>()
var array<float> bearOBBottoms = array.new<float>()

bullOB = isBearCandle[1] and isBullCandle and close > high[1] and (close - open) > atrValue * 0.3
bearOB = isBullCandle[1] and isBearCandle and close < low[1] and (open - close) > atrValue * 0.3

if showOB and bullOB and barstate.isconfirmed
    if array.size(bullOBBoxes) >= maxOB
        oldBox = array.shift(bullOBBoxes)
        box.delete(oldBox)
        array.shift(bullOBTops)
        array.shift(bullOBBottoms)
    newBox = box.new(bar_index - 1, high[1], bar_index + 30, low[1], bgcolor=obBullColor, border_color=bullColor, border_width=1)
    array.push(bullOBBoxes, newBox)
    array.push(bullOBTops, high[1])
    array.push(bullOBBottoms, low[1])

if showOB and bearOB and barstate.isconfirmed
    if array.size(bearOBBoxes) >= maxOB
        oldBox = array.shift(bearOBBoxes)
        box.delete(oldBox)
        array.shift(bearOBTops)
        array.shift(bearOBBottoms)
    newBox = box.new(bar_index - 1, high[1], bar_index + 30, low[1], bgcolor=obBearColor, border_color=bearColor, border_width=1)
    array.push(bearOBBoxes, newBox)
    array.push(bearOBTops, high[1])
    array.push(bearOBBottoms, low[1])

// Mitigar OB
if array.size(bullOBBoxes) > 0
    for i = array.size(bullOBBoxes) - 1 to 0
        if i < array.size(bullOBBottoms) and close < array.get(bullOBBottoms, i)
            box.delete(array.get(bullOBBoxes, i))
            array.remove(bullOBBoxes, i)
            array.remove(bullOBTops, i)
            array.remove(bullOBBottoms, i)

if array.size(bearOBBoxes) > 0
    for i = array.size(bearOBBoxes) - 1 to 0
        if i < array.size(bearOBTops) and close > array.get(bearOBTops, i)
            box.delete(array.get(bearOBBoxes, i))
            array.remove(bearOBBoxes, i)
            array.remove(bearOBTops, i)
            array.remove(bearOBBottoms, i)

getNearestBullOBBottom() =>
    result = close - (atrValue * atrMult)
    if array.size(bullOBBottoms) > 0
        for i = 0 to array.size(bullOBBottoms) - 1
            obBottom = array.get(bullOBBottoms, i)
            obTop = array.get(bullOBTops, i)
            if close >= obBottom and close <= obTop * 1.001
                result := obBottom
                break
    result

getNearestBearOBTop() =>
    result = close + (atrValue * atrMult)
    if array.size(bearOBTops) > 0
        for i = 0 to array.size(bearOBTops) - 1
            obTop = array.get(bearOBTops, i)
            obBottom = array.get(bearOBBottoms, i)
            if close <= obTop and close >= obBottom * 0.999
                result := obTop
                break
    result

inBullOB() =>
    result = false
    if array.size(bullOBBoxes) > 0
        for i = 0 to array.size(bullOBBoxes) - 1
            if i < array.size(bullOBTops) and i < array.size(bullOBBottoms)
                if close <= array.get(bullOBTops, i) and close >= array.get(bullOBBottoms, i)
                    result := true
    result

inBearOB() =>
    result = false
    if array.size(bearOBBoxes) > 0
        for i = 0 to array.size(bearOBBoxes) - 1
            if i < array.size(bearOBTops) and i < array.size(bearOBBottoms)
                if close <= array.get(bearOBTops, i) and close >= array.get(bearOBBottoms, i)
                    result := true
    result

// ============================================================================
// FVG - MEJORADO: CON DETECCION DE PRECIO DENTRO + CONFLUENCIA
// ============================================================================

var array<box> bullFVGBoxes = array.new<box>()
var array<box> bearFVGBoxes = array.new<box>()
var array<float> bullFVGTops = array.new<float>()
var array<float> bullFVGBottoms = array.new<float>()
var array<float> bearFVGTops = array.new<float>()
var array<float> bearFVGBottoms = array.new<float>()

fvgMinTicks = close * (fvgMinSize / 100)

// Bullish FVG: Gap entre high de vela 3 y low de vela 1 (precio subio rapido)
bullFVG = low > high[2] and (low - high[2]) > fvgMinTicks
// Bearish FVG: Gap entre low de vela 3 y high de vela 1 (precio bajo rapido)
bearFVG = high < low[2] and (low[2] - high) > fvgMinTicks

if showFVG and bullFVG and barstate.isconfirmed
    if array.size(bullFVGBoxes) >= maxFVG
        oldBox = array.shift(bullFVGBoxes)
        box.delete(oldBox)
        array.shift(bullFVGTops)
        array.shift(bullFVGBottoms)
    // Bullish FVG: Bottom = high[2], Top = low (el gap)
    fvgBottom = high[2]
    fvgTop = low
    newBox = box.new(bar_index - 2, fvgTop, bar_index + 30, fvgBottom, bgcolor=fvgBullColor, border_color=color.new(color.blue, 50), border_width=1)
    array.push(bullFVGBoxes, newBox)
    array.push(bullFVGTops, fvgTop)
    array.push(bullFVGBottoms, fvgBottom)

if showFVG and bearFVG and barstate.isconfirmed
    if array.size(bearFVGBoxes) >= maxFVG
        oldBox = array.shift(bearFVGBoxes)
        box.delete(oldBox)
        array.shift(bearFVGTops)
        array.shift(bearFVGBottoms)
    // Bearish FVG: Bottom = high, Top = low[2] (el gap)
    fvgBottom = high
    fvgTop = low[2]
    newBox = box.new(bar_index - 2, fvgTop, bar_index + 30, fvgBottom, bgcolor=fvgBearColor, border_color=color.new(color.orange, 50), border_width=1)
    array.push(bearFVGBoxes, newBox)
    array.push(bearFVGTops, fvgTop)
    array.push(bearFVGBottoms, fvgBottom)

// Mitigar FVG cuando el precio lo llena completamente
if array.size(bullFVGBoxes) > 0
    for i = array.size(bullFVGBoxes) - 1 to 0
        if i < array.size(bullFVGBottoms) and low <= array.get(bullFVGBottoms, i)
            box.delete(array.get(bullFVGBoxes, i))
            array.remove(bullFVGBoxes, i)
            array.remove(bullFVGTops, i)
            array.remove(bullFVGBottoms, i)

if array.size(bearFVGBoxes) > 0
    for i = array.size(bearFVGBoxes) - 1 to 0
        if i < array.size(bearFVGTops) and high >= array.get(bearFVGTops, i)
            box.delete(array.get(bearFVGBoxes, i))
            array.remove(bearFVGBoxes, i)
            array.remove(bearFVGTops, i)
            array.remove(bearFVGBottoms, i)

// NUEVO: Funcion para detectar si precio esta dentro de un FVG alcista
inBullFVG() =>
    result = false
    if array.size(bullFVGTops) > 0
        for i = 0 to math.min(array.size(bullFVGTops) - 1, maxFVG - 1)
            fvgTop = array.get(bullFVGTops, i)
            fvgBottom = array.get(bullFVGBottoms, i)
            // Precio entra en el FVG (toca o penetra)
            if low <= fvgTop and low >= fvgBottom
                result := true
                break
    result

// NUEVO: Funcion para detectar si precio esta dentro de un FVG bajista
inBearFVG() =>
    result = false
    if array.size(bearFVGTops) > 0
        for i = 0 to math.min(array.size(bearFVGTops) - 1, maxFVG - 1)
            fvgTop = array.get(bearFVGTops, i)
            fvgBottom = array.get(bearFVGBottoms, i)
            // Precio entra en el FVG (toca o penetra)
            if high >= fvgBottom and high <= fvgTop
                result := true
                break
    result

// ============================================================================
// LIQUIDEZ - FILTRO DE SWEEPS
// ============================================================================

recentHigh = ta.highest(high, eqhLookback)
recentLow = ta.lowest(low, eqhLookback)

liquiditySweepHighRaw = high > recentHigh[1] and close < high
liquiditySweepLowRaw = low < recentLow[1] and close > low

// Calcular si el sweep es significativo
sweepHighSize = high - recentHigh[1]
sweepLowSize = recentLow[1] - low

// Detectar Equal Highs/Lows para filtro
eqhTolerance = atrValue * 0.1
isNearEqualHigh = false
isNearEqualLow = false

for i = 1 to math.min(eqhLookback, 20)
    if math.abs(high - high[i]) < eqhTolerance
        isNearEqualHigh := true
        break
    if math.abs(low - low[i]) < eqhTolerance
        isNearEqualLow := true
        break

// Detectar si esta cerca de OB
isNearBullOB = false
isNearBearOB = false
if array.size(bullOBBottoms) > 0
    for i = 0 to math.min(array.size(bullOBBottoms) - 1, 2)
        if low < array.get(bullOBBottoms, i) * 1.002 and low > array.get(bullOBBottoms, i) * 0.995
            isNearBullOB := true
            break

if array.size(bearOBTops) > 0
    for i = 0 to math.min(array.size(bearOBTops) - 1, 2)
        if high > array.get(bearOBTops, i) * 0.998 and high < array.get(bearOBTops, i) * 1.005
            isNearBearOB := true
            break

// Aplicar filtros a los sweeps
sweepIsSignificantHigh = sweepHighSize > atrValue * sweepMinATR
sweepIsSignificantLow = sweepLowSize > atrValue * sweepMinATR

// Condiciones para sweep "clave" (filtrado)
sweepHighIsKey = sweepIsSignificantHigh and (isNearEqualHigh or isNearBearOB or inAnyKZ)
sweepLowIsKey = sweepIsSignificantLow and (isNearEqualLow or isNearBullOB or inAnyKZ)

// Decidir que sweeps mostrar
liquiditySweepHigh = filterSweeps ? (liquiditySweepHighRaw and sweepHighIsKey) : liquiditySweepHighRaw
liquiditySweepLow = filterSweeps ? (liquiditySweepLowRaw and sweepLowIsKey) : liquiditySweepLowRaw

showSweepHighLabel = showSweeps and liquiditySweepHigh and barstate.isconfirmed
showSweepLowLabel = showSweeps and liquiditySweepLow and barstate.isconfirmed

if showSweepHighLabel
    sweepLabel = sweepHighIsKey ? "SWEEP ‚ö°" : "SWEEP"
    sweepCol = sweepHighIsKey ? color.new(bearColor, 10) : color.new(bearColor, 40)
    label.new(bar_index, high, sweepLabel, style=label.style_label_down, color=sweepCol, textcolor=color.white, size=size.tiny)

if showSweepLowLabel
    sweepLabel = sweepLowIsKey ? "SWEEP ‚ö°" : "SWEEP"
    sweepCol = sweepLowIsKey ? color.new(bullColor, 10) : color.new(bullColor, 40)
    label.new(bar_index, low, sweepLabel, style=label.style_label_up, color=sweepCol, textcolor=color.white, size=size.tiny)

// Equal Highs/Lows visualization
isEqualHigh = math.abs(high - high[1]) < eqhTolerance and high == ta.highest(high, 5)
isEqualLow = math.abs(low - low[1]) < eqhTolerance and low == ta.lowest(low, 5)

if showEQHL and isEqualHigh and barstate.isconfirmed
    line.new(bar_index - 1, high[1], bar_index + 5, high, color=color.new(bearColor, 50), style=line.style_dotted, width=1)
if showEQHL and isEqualLow and barstate.isconfirmed
    line.new(bar_index - 1, low[1], bar_index + 5, low, color=color.new(bullColor, 50), style=line.style_dotted, width=1)

// ============================================================================
// FIBONACCI
// ============================================================================

fibHigh = ta.highest(high, fibLookback)
fibLow = ta.lowest(low, fibLookback)
fibRange = fibHigh - fibLow
fib500 = fibHigh - fibRange * 0.500
fib618 = fibHigh - fibRange * 0.618

inDiscount = close < fib500
inPremium = close > fib500

var line fib500Line = na
if showFib and barstate.islast
    line.delete(fib500Line)
    fib500Line := line.new(bar_index - fibLookback, fib500, bar_index + 5, fib500, color=color.new(color.white, 50), style=line.style_dashed, width=1)

zonaName = inDiscount ? "DISCOUNT" : "PREMIUM"

// ============================================================================
// PATRONES DE VELA
// ============================================================================

bullRejection = lowerWick > bodySize * 1.5 and lowerWick > upperWick * 2 and bodySize > 0
bearRejection = upperWick > bodySize * 1.5 and upperWick > lowerWick * 2 and bodySize > 0
bullEngulfing = isBullCandle and isBearCandle[1] and close > open[1] and open <= close[1]
bearEngulfing = isBearCandle and isBullCandle[1] and close < open[1] and open >= close[1]
bullContinuation = close > high[1] or bullEngulfing
bearContinuation = close < low[1] or bearEngulfing

// ============================================================================
// SISTEMA DE CONFLUENCIAS - ACTUALIZADO: 8 CONFLUENCIAS (con FVG)
// ============================================================================

isInBullOB = inBullOB()
isInBearOB = inBearOB()
// NUEVO: Detectar si esta en FVG
isInBullFVG = inBullFVG()
isInBearFVG = inBearFVG()

// Confluencias LONG (max 8)
confLong = 0
confLong := confLong + (trendUp ? 1 : 0)                                          // 1. Tendencia corto plazo
confLong := confLong + (htfTrendUp ? 1 : 0)                                        // 2. Tendencia largo plazo
confLong := confLong + (isInBullOB ? 1 : 0)                                        // 3. Order Block
confLong := confLong + (inDiscount ? 1 : 0)                                        // 4. Zona Fib
confLong := confLong + (bullRejection or bullEngulfing ? 1 : 0)                    // 5. Patron de vela
confLong := confLong + (liquiditySweepLow[1] or liquiditySweepLow[2] ? 1 : 0)      // 6. Liquidity Sweep
confLong := confLong + (choch_bull[1] or choch_bull[2] or bos_bull[1] ? 1 : 0)     // 7. Estructura
confLong := confLong + (useFVGConfluence and isInBullFVG ? 1 : 0)                  // 8. FVG (NUEVO)

// Confluencias SHORT (max 8)
confShort = 0
confShort := confShort + (trendDown ? 1 : 0)                                        // 1. Tendencia corto plazo
confShort := confShort + (htfTrendDown ? 1 : 0)                                     // 2. Tendencia largo plazo
confShort := confShort + (isInBearOB ? 1 : 0)                                       // 3. Order Block
confShort := confShort + (inPremium ? 1 : 0)                                        // 4. Zona Fib
confShort := confShort + (bearRejection or bearEngulfing ? 1 : 0)                   // 5. Patron de vela
confShort := confShort + (liquiditySweepHigh[1] or liquiditySweepHigh[2] ? 1 : 0)   // 6. Liquidity Sweep
confShort := confShort + (choch_bear[1] or choch_bear[2] or bos_bear[1] ? 1 : 0)    // 7. Estructura
confShort := confShort + (useFVGConfluence and isInBearFVG ? 1 : 0)                 // 8. FVG (NUEVO)

trendName = trendUp and htfTrendUp ? "BULL" : trendDown and htfTrendDown ? "BEAR" : "MIX"

// ============================================================================
// SENALES
// ============================================================================

kzFilter = onlyTradeKZ ? inAnyKZ : true

longCondition = confLong >= minConfluence and bullContinuation and kzFilter and barstate.isconfirmed
shortCondition = confShort >= minConfluence and bearContinuation and kzFilter and barstate.isconfirmed

var bool lastSignalLong = false
var bool lastSignalShort = false
var int lastSignalBar = 0

if choch_bull or choch_bear
    lastSignalLong := false
    lastSignalShort := false

longSignal = longCondition and not lastSignalLong and (bar_index - lastSignalBar > 10)
shortSignal = shortCondition and not lastSignalShort and (bar_index - lastSignalBar > 10)

if longSignal
    lastSignalLong := true
    lastSignalShort := false
    lastSignalBar := bar_index

if shortSignal
    lastSignalShort := true
    lastSignalLong := false
    lastSignalBar := bar_index

// ============================================================================
// VISUALIZACION
// ============================================================================

plot(emaFast, "EMA 9", color=bullColor, linewidth=2)
plot(emaSlow, "EMA 21", color=bearColor, linewidth=2)
plot(showEMA200 ? ema200 : na, "EMA 200", color=color.new(color.white, 60), linewidth=1)

plotshape(showSignals and longSignal, title="LONG", style=shape.triangleup, location=location.belowbar, color=bullColor, size=size.normal)
plotshape(showSignals and shortSignal, title="SHORT", style=shape.triangledown, location=location.abovebar, color=bearColor, size=size.normal)

// Labels con SL/TP - ACTUALIZADO: Ahora muestra X/8
if showSignals and showLabels and longSignal
    slBase = useOBforSL ? getNearestBullOBBottom() : close - (atrValue * atrMult)
    slPrice = slBase - totalSpreadBuffer
    riskAmount = close - slPrice
    tpPrice = close + (riskAmount * rrRatio)
    slPips = (close - slPrice) * 100
    tpPips = (tpPrice - close) * 100
    slType = useOBforSL and isInBullOB ? "OB" : "ATR"
    fvgTxt = isInBullFVG ? " +FVG" : ""
    
    label.new(bar_index, low, 
      "LONG " + str.tostring(confLong) + "/8" + fvgTxt + "\n" +
      "SL[" + slType + "]: " + str.tostring(slPrice, "#.###") + " (" + str.tostring(slPips, "#.#") + "p)\n" +
      "TP: " + str.tostring(tpPrice, "#.###") + " (" + str.tostring(tpPips, "#.#") + "p)", 
      style=label.style_label_up, color=color.new(bullColor, 10), textcolor=color.white, size=size.small)

if showSignals and showLabels and shortSignal
    slBase = useOBforSL ? getNearestBearOBTop() : close + (atrValue * atrMult)
    slPrice = slBase + totalSpreadBuffer
    riskAmount = slPrice - close
    tpPrice = close - (riskAmount * rrRatio)
    slPips = (slPrice - close) * 100
    tpPips = (close - tpPrice) * 100
    slType = useOBforSL and isInBearOB ? "OB" : "ATR"
    fvgTxt = isInBearFVG ? " +FVG" : ""
    
    label.new(bar_index, high, 
      "SHORT " + str.tostring(confShort) + "/8" + fvgTxt + "\n" +
      "SL[" + slType + "]: " + str.tostring(slPrice, "#.###") + " (" + str.tostring(slPips, "#.#") + "p)\n" +
      "TP: " + str.tostring(tpPrice, "#.###") + " (" + str.tostring(tpPips, "#.#") + "p)", 
      style=label.style_label_down, color=color.new(bearColor, 10), textcolor=color.white, size=size.small)

// ============================================================================
// PANEL INFORMATIVO - ACTUALIZADO: Ahora muestra FVG
// ============================================================================

var table panel = table.new(position.top_right, 2, 14, bgcolor=color.new(color.black, 85), border_width=1, border_color=color.gray)

if showPanel and barstate.islast
    trendTxt = trendUp and htfTrendUp ? "BULL" : trendDown and htfTrendDown ? "BEAR" : "MIX"
    trendCol = trendUp and htfTrendUp ? bullColor : trendDown and htfTrendDown ? bearColor : color.yellow
    
    kzTxt = inTokyoKZ and showTokyoKZ ? "TOKYO" : inLondonKZ ? "LONDON" : inNYKZ ? "NY" : inNYOverlap ? "NY-OVL" : "-"
    kzCol = inAnyKZ ? color.lime : color.gray
    
    zonaTxt = inDiscount ? "DISCOUNT" : "PREMIUM"
    zonaCol = inDiscount ? bullColor : bearColor
    
    // NUEVO: Texto para FVG
    fvgTxt = isInBullFVG ? "BULL" : isInBearFVG ? "BEAR" : "-"
    fvgCol = isInBullFVG ? color.rgb(0, 150, 255) : isInBearFVG ? color.rgb(255, 150, 0) : color.gray
    
    table.cell(panel, 0, 0, "SMS-JPY v4", text_color=color.rgb(255, 100, 200), text_size=size.small)
    table.cell(panel, 1, 0, "FVG+", text_color=color.rgb(0, 150, 255), text_size=size.small)
    
    table.cell(panel, 0, 1, "Trend", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 1, trendTxt, text_color=trendCol, text_size=size.tiny)
    
    table.cell(panel, 0, 2, "KZ", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 2, kzTxt, text_color=kzCol, text_size=size.tiny)
    
    table.cell(panel, 0, 3, "Zona", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 3, zonaTxt, text_color=zonaCol, text_size=size.tiny)
    
    table.cell(panel, 0, 4, "ATR", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 4, str.tostring(atrValue * 100, "#.#") + "p", text_color=color.orange, text_size=size.tiny)
    
    table.cell(panel, 0, 5, "OB", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 5, isInBullOB ? "BULL" : isInBearOB ? "BEAR" : "-", text_color=isInBullOB ? bullColor : isInBearOB ? bearColor : color.gray, text_size=size.tiny)
    
    // NUEVO: FVG en panel
    table.cell(panel, 0, 6, "FVG", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 6, fvgTxt, text_color=fvgCol, text_size=size.tiny)
    
    table.cell(panel, 0, 7, "L-Conf", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 7, str.tostring(confLong) + "/8", text_color=confLong >= minConfluence ? bullColor : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 8, "S-Conf", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 8, str.tostring(confShort) + "/8", text_color=confShort >= minConfluence ? bearColor : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 9, "Spread", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 9, str.tostring(spreadPips, "#.#") + "p", text_color=color.orange, text_size=size.tiny)
    
    table.cell(panel, 0, 10, "SL Mode", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 10, useOBforSL ? "OB+Spread" : "ATR", text_color=color.aqua, text_size=size.tiny)
    
    table.cell(panel, 0, 11, "Tokyo KZ", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 11, showTokyoKZ ? "ON" : "OFF", text_color=showTokyoKZ ? color.rgb(255, 100, 200) : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 12, "Alertas", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 12, enableAlerts ? "ON" : "OFF", text_color=enableAlerts ? color.lime : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 13, "FVG Conf", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 13, useFVGConfluence ? "ON" : "OFF", text_color=useFVGConfluence ? color.lime : color.gray, text_size=size.tiny)

// ============================================================================
// ALERTAS DINAMICAS
// ============================================================================

slLongCalc = useOBforSL ? getNearestBullOBBottom() - totalSpreadBuffer : close - (atrValue * atrMult) - totalSpreadBuffer
tpLongCalc = close + ((close - slLongCalc) * rrRatio)
slShortCalc = useOBforSL ? getNearestBearOBTop() + totalSpreadBuffer : close + (atrValue * atrMult) + totalSpreadBuffer
tpShortCalc = close - ((slShortCalc - close) * rrRatio)

slLongPips = (close - slLongCalc) * 100
tpLongPips = (tpLongCalc - close) * 100
slShortPips = (slShortCalc - close) * 100
tpShortPips = (close - tpShortCalc) * 100

fvgLongTxt = isInBullFVG ? "‚úÖ" : "‚ùå"
fvgShortTxt = isInBearFVG ? "‚úÖ" : "‚ùå"

longMessage = "üü¢ LONG USDJPY\n" +
     "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
     "üìç Entrada: " + str.tostring(close, "#.###") + "\n" +
     "üõë SL: " + str.tostring(slLongCalc, "#.###") + " (" + str.tostring(slLongPips, "#.#") + "p)\n" +
     "üéØ TP: " + str.tostring(tpLongCalc, "#.###") + " (" + str.tostring(tpLongPips, "#.#") + "p)\n" +
     "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
     "üìä Confluencias: " + str.tostring(confLong) + "/8\n" +
     "üì¶ FVG: " + fvgLongTxt + "\n" +
     "‚è∞ Kill Zone: " + kzName + "\n" +
     "üìà Tendencia: " + trendName + "\n" +
     "üéöÔ∏è Zona: " + zonaName

shortMessage = "üî¥ SHORT USDJPY\n" +
     "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
     "üìç Entrada: " + str.tostring(close, "#.###") + "\n" +
     "üõë SL: " + str.tostring(slShortCalc, "#.###") + " (" + str.tostring(slShortPips, "#.#") + "p)\n" +
     "üéØ TP: " + str.tostring(tpShortCalc, "#.###") + " (" + str.tostring(tpShortPips, "#.#") + "p)\n" +
     "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
     "üìä Confluencias: " + str.tostring(confShort) + "/8\n" +
     "üì¶ FVG: " + fvgShortTxt + "\n" +
     "‚è∞ Kill Zone: " + kzName + "\n" +
     "üìà Tendencia: " + trendName + "\n" +
     "üéöÔ∏è Zona: " + zonaName

if enableAlerts and longSignal
    alert(longMessage, alert.freq_once_per_bar_close)

if enableAlerts and shortSignal
    alert(shortMessage, alert.freq_once_per_bar_close)

if enableAlerts and alertOnCHoCH and choch_bull_confirmed
    alert("‚ö° CHoCH ALCISTA USDJPY @ " + str.tostring(close, "#.###") + " | KZ: " + kzName, alert.freq_once_per_bar_close)

if enableAlerts and alertOnCHoCH and choch_bear_confirmed
    alert("‚ö° CHoCH BAJISTA USDJPY @ " + str.tostring(close, "#.###") + " | KZ: " + kzName, alert.freq_once_per_bar_close)

if enableAlerts and alertOnBOS and bos_bull_confirmed
    alert("üìà BOS ALCISTA USDJPY @ " + str.tostring(close, "#.###") + " | KZ: " + kzName, alert.freq_once_per_bar_close)

if enableAlerts and alertOnBOS and bos_bear_confirmed
    alert("üìâ BOS BAJISTA USDJPY @ " + str.tostring(close, "#.###") + " | KZ: " + kzName, alert.freq_once_per_bar_close)

if enableAlerts and alertOnSweeps and showSweepHighLabel
    alert("üíß SWEEP HIGHS USDJPY @ " + str.tostring(close, "#.###") + " | KZ: " + kzName, alert.freq_once_per_bar_close)

if enableAlerts and alertOnSweeps and showSweepLowLabel
    alert("üíß SWEEP LOWS USDJPY @ " + str.tostring(close, "#.###") + " | KZ: " + kzName, alert.freq_once_per_bar_close)

// ============================================================================
// ALERTCONDITIONS
// ============================================================================

alertcondition(longSignal, title="LONG Signal", message="LONG USDJPY")
alertcondition(shortSignal, title="SHORT Signal", message="SHORT USDJPY")
alertcondition(choch_bull_confirmed, title="CHoCH BULL", message="CHoCH Alcista USDJPY")
alertcondition(choch_bear_confirmed, title="CHoCH BEAR", message="CHoCH Bajista USDJPY")
alertcondition(bos_bull_confirmed, title="BOS BULL", message="BOS Alcista USDJPY")
alertcondition(bos_bear_confirmed, title="BOS BEAR", message="BOS Bajista USDJPY")
alertcondition(showSweepHighLabel, title="SWEEP HIGH", message="Sweep Highs USDJPY")
alertcondition(showSweepLowLabel, title="SWEEP LOW", message="Sweep Lows USDJPY")
