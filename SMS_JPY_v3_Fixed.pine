//@version=6
indicator("SMS Pro USDJPY v3", shorttitle="SMS-JPY", overlay=true, max_lines_count=100, max_labels_count=200, max_boxes_count=100)

// ============================================================================
// CONFIGURACION PRINCIPAL - OPTIMIZADO PARA USD/JPY
// ============================================================================

// EMAs
emaFastLen = input.int(9, "EMA Rapida", minval=1, group="EMAs")
emaSlowLen = input.int(21, "EMA Lenta", minval=1, group="EMAs")
ema200Len = input.int(200, "EMA 200", minval=50, group="EMAs")
showEMA200 = input.bool(true, "Mostrar EMA 200", group="EMAs")

// Market Structure
swingLen = input.int(5, "Swing Lookback", minval=2, maxval=20, group="Structure")
showBOS = input.bool(true, "Mostrar BOS", group="Structure")
showCHOCH = input.bool(true, "Mostrar CHoCH", group="Structure")

// Order Blocks
showOB = input.bool(true, "Mostrar Order Blocks", group="Order Blocks")
maxOB = input.int(3, "Max Order Blocks visibles", minval=1, maxval=10, group="Order Blocks")

// FVG - Ajustado para USD/JPY (volatilidad moderada)
showFVG = input.bool(true, "Mostrar FVG", group="FVG")
fvgMinSize = input.float(0.03, "Tamano minimo FVG %", minval=0.01, maxval=0.5, group="FVG")
maxFVG = input.int(3, "Max FVG visibles", minval=1, maxval=10, group="FVG")

// Liquidez - Filtros para sweeps
showSweeps = input.bool(true, "Mostrar Liquidity Sweeps", group="Liquidez")
showEQHL = input.bool(false, "Mostrar Equal H/L", group="Liquidez")
eqhLookback = input.int(15, "Lookback", minval=5, maxval=50, group="Liquidez")
filterSweeps = input.bool(true, "Filtrar Sweeps (solo zonas clave)", group="Liquidez")
sweepMinATR = input.float(0.3, "Sweep minimo (x ATR)", minval=0.1, maxval=1.0, group="Liquidez")

// Kill Zones - Incluye TOKYO para pares JPY
showKillZones = input.bool(true, "Mostrar Kill Zones", group="Kill Zones")
onlyTradeKZ = input.bool(false, "Solo senales en Kill Zone", group="Kill Zones")
showTokyoKZ = input.bool(true, "Mostrar Tokyo KZ", group="Kill Zones")

// Fibonacci
showFib = input.bool(true, "Mostrar Fib 50%", group="Fibonacci")
fibLookback = input.int(30, "Lookback", minval=10, maxval=100, group="Fibonacci")

// Senales
showSignals = input.bool(true, "Mostrar Senales", group="Senales")
minConfluence = input.int(3, "Minimo Confluencias", minval=2, maxval=6, group="Senales")
showLabels = input.bool(true, "Mostrar Labels SL/TP", group="Senales")

// ATR - Ajustado para USD/JPY
atrLen = input.int(14, "Periodo ATR", minval=5, maxval=50, group="ATR")
atrMult = input.float(1.2, "Multiplicador SL", minval=0.5, maxval=3.0, group="ATR")
rrRatio = input.float(2.0, "Ratio Riesgo:Beneficio", minval=1.0, maxval=5.0, group="ATR")
useOBforSL = input.bool(true, "Usar Order Block para SL", group="ATR")

// SPREAD - Configuracion de spread para JPY
spreadPips = input.float(1.5, "Spread estimado (pips)", minval=0.5, maxval=5.0, group="Spread", tooltip="USD/JPY tipico: 1.0-2.0 pips")
addSpreadToSL = input.bool(true, "Agregar spread al SL", group="Spread")
spreadBuffer = input.float(0.5, "Buffer adicional (pips)", minval=0.0, maxval=2.0, group="Spread")

// ALERTAS - NUEVO: Control de alertas
enableAlerts = input.bool(true, "Habilitar Alertas", group="Alertas")
alertOnSweeps = input.bool(false, "Alertas de Sweeps", group="Alertas", tooltip="Desactivado por defecto para evitar ruido")
alertOnCHoCH = input.bool(true, "Alertas de CHoCH", group="Alertas")
alertOnBOS = input.bool(false, "Alertas de BOS", group="Alertas")

// Panel
showPanel = input.bool(true, "Mostrar Panel Info", group="Visual")

// ============================================================================
// COLORES
// ============================================================================

bullColor = color.rgb(0, 230, 118)
bearColor = color.rgb(255, 82, 82)
bosColor = color.rgb(0, 188, 212)
chochColor = color.rgb(255, 152, 0)
obBullColor = color.new(color.rgb(38, 166, 154), 80)
obBearColor = color.new(color.rgb(239, 83, 80), 80)
fvgBullColor = color.new(bullColor, 85)
fvgBearColor = color.new(bearColor, 85)
tokyoColor = color.new(color.rgb(255, 193, 7), 93)
sweepKeyColor = color.new(color.rgb(255, 215, 0), 20)

// ============================================================================
// CALCULOS BASE
// ============================================================================

emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)
ema200 = ta.ema(close, ema200Len)
atrValue = ta.atr(atrLen)

// Conversion spread a precio (USD/JPY: 1 pip = 0.01)
spreadInPrice = spreadPips * 0.01
bufferInPrice = spreadBuffer * 0.01
totalSpreadBuffer = addSpreadToSL ? (spreadInPrice + bufferInPrice) : 0

trendUp = emaFast > emaSlow
trendDown = emaFast < emaSlow
htfTrendUp = close > ema200
htfTrendDown = close < ema200

bodySize = math.abs(close - open)
candleRange = high - low
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
isBullCandle = close > open
isBearCandle = close < open

// ============================================================================
// KILL ZONES - INCLUYE TOKYO PARA USD/JPY (Movido arriba para usar en filtros)
// ============================================================================

utcHour = hour(time, "UTC")
estHour = (utcHour - 5 + 24) % 24
jstHour = (utcHour + 9) % 24  // Japan Standard Time

// Kill Zones en EST
inTokyoKZ = estHour >= 19 or estHour < 2      // Tokyo: 19:00-02:00 EST (09:00-12:00 JST activo)
inLondonKZ = estHour >= 2 and estHour < 5     // London: 02:00-05:00 EST
inNYKZ = estHour >= 7 and estHour < 10        // NY: 07:00-10:00 EST
inNYOverlap = estHour >= 8 and estHour < 11   // NY Overlap: 08:00-11:00 EST
inAnyKZ = (showTokyoKZ and inTokyoKZ) or inLondonKZ or inNYKZ or inNYOverlap

// Color de fondo segun Kill Zone
kzBgColor = showKillZones ? (showTokyoKZ and inTokyoKZ ? tokyoColor : inLondonKZ ? color.new(color.blue, 93) : inNYKZ or inNYOverlap ? color.new(color.green, 93) : na) : na
bgcolor(kzBgColor)

// Variable para nombre de KZ (para alertas)
kzName = showTokyoKZ and inTokyoKZ ? "TOKYO" : inLondonKZ ? "LONDON" : inNYKZ ? "NEW YORK" : inNYOverlap ? "NY-OVERLAP" : "FUERA KZ"

// ============================================================================
// MARKET STRUCTURE
// ============================================================================

swingHigh = ta.pivothigh(high, swingLen, swingLen)
swingLow = ta.pivotlow(low, swingLen, swingLen)

var float lastSwingHigh = na
var float lastSwingLow = na
var int trendDir = 0

if not na(swingHigh)
    lastSwingHigh := swingHigh
if not na(swingLow)
    lastSwingLow := swingLow

crossOverHigh = ta.crossover(close, nz(lastSwingHigh, high))
crossUnderLow = ta.crossunder(close, nz(lastSwingLow, low))

bos_bull = not na(lastSwingHigh) and crossOverHigh and trendDir == 1
bos_bear = not na(lastSwingLow) and crossUnderLow and trendDir == -1
choch_bull = not na(lastSwingHigh) and crossOverHigh and trendDir == -1
choch_bear = not na(lastSwingLow) and crossUnderLow and trendDir == 1

if choch_bull or bos_bull
    trendDir := 1
if choch_bear or bos_bear
    trendDir := -1

// CORREGIDO: Variables confirmadas para sincronizar labels Y alertas
bos_bull_confirmed = showBOS and bos_bull and barstate.isconfirmed
bos_bear_confirmed = showBOS and bos_bear and barstate.isconfirmed
choch_bull_confirmed = showCHOCH and choch_bull and barstate.isconfirmed
choch_bear_confirmed = showCHOCH and choch_bear and barstate.isconfirmed

if bos_bull_confirmed
    label.new(bar_index, low, "BOS", style=label.style_label_up, color=bosColor, textcolor=color.white, size=size.tiny)
if bos_bear_confirmed
    label.new(bar_index, high, "BOS", style=label.style_label_down, color=bosColor, textcolor=color.white, size=size.tiny)
if choch_bull_confirmed
    label.new(bar_index, low, "CHoCH", style=label.style_label_up, color=chochColor, textcolor=color.white, size=size.small)
if choch_bear_confirmed
    label.new(bar_index, high, "CHoCH", style=label.style_label_down, color=chochColor, textcolor=color.white, size=size.small)

// ============================================================================
// ORDER BLOCKS - CON ALMACENAMIENTO PARA SL
// ============================================================================

var array<box> bullOBBoxes = array.new<box>()
var array<box> bearOBBoxes = array.new<box>()
var array<float> bullOBTops = array.new<float>()
var array<float> bullOBBottoms = array.new<float>()
var array<float> bearOBTops = array.new<float>()
var array<float> bearOBBottoms = array.new<float>()

bullOB = isBearCandle[1] and isBullCandle and close > high[1] and (close - open) > atrValue * 0.5
bearOB = isBullCandle[1] and isBearCandle and close < low[1] and (open - close) > atrValue * 0.5

if showOB and bullOB and barstate.isconfirmed
    if array.size(bullOBBoxes) >= maxOB
        oldBox = array.shift(bullOBBoxes)
        box.delete(oldBox)
        array.shift(bullOBTops)
        array.shift(bullOBBottoms)
    newBox = box.new(bar_index - 1, high[1], bar_index + 30, low[1], bgcolor=obBullColor, border_color=bullColor, border_width=1)
    array.push(bullOBBoxes, newBox)
    array.push(bullOBTops, high[1])
    array.push(bullOBBottoms, low[1])

if showOB and bearOB and barstate.isconfirmed
    if array.size(bearOBBoxes) >= maxOB
        oldBox = array.shift(bearOBBoxes)
        box.delete(oldBox)
        array.shift(bearOBTops)
        array.shift(bearOBBottoms)
    newBox = box.new(bar_index - 1, high[1], bar_index + 30, low[1], bgcolor=obBearColor, border_color=bearColor, border_width=1)
    array.push(bearOBBoxes, newBox)
    array.push(bearOBTops, high[1])
    array.push(bearOBBottoms, low[1])

if array.size(bullOBBoxes) > 0
    for i = array.size(bullOBBoxes) - 1 to 0
        if i < array.size(bullOBBottoms) and close < array.get(bullOBBottoms, i)
            box.delete(array.get(bullOBBoxes, i))
            array.remove(bullOBBoxes, i)
            array.remove(bullOBTops, i)
            array.remove(bullOBBottoms, i)

if array.size(bearOBBoxes) > 0
    for i = array.size(bearOBBoxes) - 1 to 0
        if i < array.size(bearOBTops) and close > array.get(bearOBTops, i)
            box.delete(array.get(bearOBBoxes, i))
            array.remove(bearOBBoxes, i)
            array.remove(bearOBTops, i)
            array.remove(bearOBBottoms, i)

// Funcion para obtener el bottom del OB mas cercano (para SL de LONG)
getNearestBullOBBottom() =>
    result = na(atrValue) ? close - 0.50 : close - (atrValue * atrMult)
    if array.size(bullOBBottoms) > 0
        for i = 0 to array.size(bullOBBottoms) - 1
            obBottom = array.get(bullOBBottoms, i)
            obTop = array.get(bullOBTops, i)
            if close >= obBottom and close <= obTop * 1.002
                result := obBottom
                break
    result

// Funcion para obtener el top del OB mas cercano (para SL de SHORT)
getNearestBearOBTop() =>
    result = na(atrValue) ? close + 0.50 : close + (atrValue * atrMult)
    if array.size(bearOBTops) > 0
        for i = 0 to array.size(bearOBTops) - 1
            obTop = array.get(bearOBTops, i)
            obBottom = array.get(bearOBBottoms, i)
            if close <= obTop and close >= obBottom * 0.998
                result := obTop
                break
    result

inBullOB() =>
    result = false
    if array.size(bullOBBoxes) > 0
        for i = 0 to array.size(bullOBBoxes) - 1
            if i < array.size(bullOBTops) and i < array.size(bullOBBottoms)
                if close <= array.get(bullOBTops, i) and close >= array.get(bullOBBottoms, i)
                    result := true
    result

inBearOB() =>
    result = false
    if array.size(bearOBBoxes) > 0
        for i = 0 to array.size(bearOBBoxes) - 1
            if i < array.size(bearOBTops) and i < array.size(bearOBBottoms)
                if close <= array.get(bearOBTops, i) and close >= array.get(bearOBBottoms, i)
                    result := true
    result

// ============================================================================
// FVG (Fair Value Gaps) - Ajustado para USD/JPY
// ============================================================================

var array<box> bullFVGBoxes = array.new<box>()
var array<box> bearFVGBoxes = array.new<box>()

fvgMinPct = fvgMinSize / 100
bullFVG = low > high[2] and (low - high[2]) > close * fvgMinPct
bearFVG = high < low[2] and (low[2] - high) > close * fvgMinPct

if showFVG and bullFVG and barstate.isconfirmed
    if array.size(bullFVGBoxes) >= maxFVG
        oldBox = array.shift(bullFVGBoxes)
        box.delete(oldBox)
    newBox = box.new(bar_index - 2, low, bar_index + 20, high[2], bgcolor=fvgBullColor, border_color=color.new(bullColor, 50), border_width=1)
    array.push(bullFVGBoxes, newBox)

if showFVG and bearFVG and barstate.isconfirmed
    if array.size(bearFVGBoxes) >= maxFVG
        oldBox = array.shift(bearFVGBoxes)
        box.delete(oldBox)
    newBox = box.new(bar_index - 2, low[2], bar_index + 20, high, bgcolor=fvgBearColor, border_color=color.new(bearColor, 50), border_width=1)
    array.push(bearFVGBoxes, newBox)

// ============================================================================
// LIQUIDEZ - FILTRO DE SWEEPS CORREGIDO
// ============================================================================

recentHigh = ta.highest(high, eqhLookback)
recentLow = ta.lowest(low, eqhLookback)

// Deteccion basica de sweep
liquiditySweepHighRaw = high > recentHigh[1] and close < high
liquiditySweepLowRaw = low < recentLow[1] and close > low

// Calcular si el sweep es significativo
sweepHighSize = high - recentHigh[1]
sweepLowSize = recentLow[1] - low

// Detectar Equal Highs/Lows para filtro
eqhTolerance = atrValue * 0.1
isNearEqualHigh = false
isNearEqualLow = false

for i = 1 to math.min(eqhLookback, 20)
    if math.abs(high - high[i]) < eqhTolerance
        isNearEqualHigh := true
        break
    if math.abs(low - low[i]) < eqhTolerance
        isNearEqualLow := true
        break

// Detectar si esta cerca de OB
isNearBullOB = false
isNearBearOB = false
if array.size(bullOBBottoms) > 0
    for i = 0 to math.min(array.size(bullOBBottoms) - 1, 2)
        if low < array.get(bullOBBottoms, i) * 1.002 and low > array.get(bullOBBottoms, i) * 0.995
            isNearBullOB := true
            break

if array.size(bearOBTops) > 0
    for i = 0 to math.min(array.size(bearOBTops) - 1, 2)
        if high > array.get(bearOBTops, i) * 0.998 and high < array.get(bearOBTops, i) * 1.005
            isNearBearOB := true
            break

// Aplicar filtros a los sweeps
sweepIsSignificantHigh = sweepHighSize > atrValue * sweepMinATR
sweepIsSignificantLow = sweepLowSize > atrValue * sweepMinATR

// Condiciones para sweep "clave" (filtrado)
sweepHighIsKey = sweepIsSignificantHigh and (isNearEqualHigh or isNearBearOB or inAnyKZ)
sweepLowIsKey = sweepIsSignificantLow and (isNearEqualLow or isNearBullOB or inAnyKZ)

// Decidir que sweeps mostrar
liquiditySweepHigh = filterSweeps ? (liquiditySweepHighRaw and sweepHighIsKey) : liquiditySweepHighRaw
liquiditySweepLow = filterSweeps ? (liquiditySweepLowRaw and sweepLowIsKey) : liquiditySweepLowRaw

// CORREGIDO: Variables para sincronizar labels Y alertas
showSweepHighLabel = showSweeps and liquiditySweepHigh and barstate.isconfirmed
showSweepLowLabel = showSweeps and liquiditySweepLow and barstate.isconfirmed

// Labels para sweeps
if showSweepHighLabel
    sweepLabel = sweepHighIsKey ? "SWEEP ‚ö°" : "SWEEP"
    sweepCol = sweepHighIsKey ? color.new(bearColor, 10) : color.new(bearColor, 40)
    label.new(bar_index, high, sweepLabel, style=label.style_label_down, color=sweepCol, textcolor=color.white, size=size.tiny)

if showSweepLowLabel
    sweepLabel = sweepLowIsKey ? "SWEEP ‚ö°" : "SWEEP"
    sweepCol = sweepLowIsKey ? color.new(bullColor, 10) : color.new(bullColor, 40)
    label.new(bar_index, low, sweepLabel, style=label.style_label_up, color=sweepCol, textcolor=color.white, size=size.tiny)

// Equal Highs/Lows visualization
isEqualHigh = math.abs(high - high[1]) < eqhTolerance and high == ta.highest(high, 5)
isEqualLow = math.abs(low - low[1]) < eqhTolerance and low == ta.lowest(low, 5)

if showEQHL and isEqualHigh and barstate.isconfirmed
    line.new(bar_index - 1, high[1], bar_index + 5, high, color=color.new(bearColor, 50), style=line.style_dotted, width=1)
if showEQHL and isEqualLow and barstate.isconfirmed
    line.new(bar_index - 1, low[1], bar_index + 5, low, color=color.new(bullColor, 50), style=line.style_dotted, width=1)

// ============================================================================
// FIBONACCI
// ============================================================================

fibHigh = ta.highest(high, fibLookback)
fibLow = ta.lowest(low, fibLookback)
fibRange = fibHigh - fibLow
fib500 = fibHigh - fibRange * 0.500
fib618 = fibHigh - fibRange * 0.618

inDiscount = close < fib500
inPremium = close > fib500

var line fib500Line = na
if showFib and barstate.islast
    line.delete(fib500Line)
    fib500Line := line.new(bar_index - fibLookback, fib500, bar_index + 5, fib500, color=color.new(color.white, 50), style=line.style_dashed, width=1)

zonaName = inDiscount ? "DISCOUNT" : "PREMIUM"

// ============================================================================
// PATRONES DE VELA
// ============================================================================

bullRejection = lowerWick > bodySize * 1.5 and lowerWick > upperWick * 2 and bodySize > 0
bearRejection = upperWick > bodySize * 1.5 and upperWick > lowerWick * 2 and bodySize > 0
bullEngulfing = isBullCandle and isBearCandle[1] and close > open[1] and open <= close[1]
bearEngulfing = isBearCandle and isBullCandle[1] and close < open[1] and open >= close[1]
bullContinuation = close > high[1] or bullEngulfing
bearContinuation = close < low[1] or bearEngulfing

// ============================================================================
// SISTEMA DE CONFLUENCIAS
// ============================================================================

isInBullOB = inBullOB()
isInBearOB = inBearOB()

confLong = 0
confLong := confLong + (trendUp ? 1 : 0)
confLong := confLong + (htfTrendUp ? 1 : 0)
confLong := confLong + (isInBullOB ? 1 : 0)
confLong := confLong + (inDiscount ? 1 : 0)
confLong := confLong + (bullRejection or bullEngulfing ? 1 : 0)
confLong := confLong + (liquiditySweepLow[1] or liquiditySweepLow[2] ? 1 : 0)
confLong := confLong + (choch_bull[1] or choch_bull[2] or bos_bull[1] ? 1 : 0)

confShort = 0
confShort := confShort + (trendDown ? 1 : 0)
confShort := confShort + (htfTrendDown ? 1 : 0)
confShort := confShort + (isInBearOB ? 1 : 0)
confShort := confShort + (inPremium ? 1 : 0)
confShort := confShort + (bearRejection or bearEngulfing ? 1 : 0)
confShort := confShort + (liquiditySweepHigh[1] or liquiditySweepHigh[2] ? 1 : 0)
confShort := confShort + (choch_bear[1] or choch_bear[2] or bos_bear[1] ? 1 : 0)

trendName = trendUp and htfTrendUp ? "BULL" : trendDown and htfTrendDown ? "BEAR" : "MIX"

// ============================================================================
// SENALES
// ============================================================================

kzFilter = onlyTradeKZ ? inAnyKZ : true

longCondition = confLong >= minConfluence and bullContinuation and kzFilter and barstate.isconfirmed
shortCondition = confShort >= minConfluence and bearContinuation and kzFilter and barstate.isconfirmed

var bool lastSignalLong = false
var bool lastSignalShort = false
var int lastSignalBar = 0

if choch_bull or choch_bear
    lastSignalLong := false
    lastSignalShort := false

longSignal = longCondition and not lastSignalLong and (bar_index - lastSignalBar > 10)
shortSignal = shortCondition and not lastSignalShort and (bar_index - lastSignalBar > 10)

if longSignal
    lastSignalLong := true
    lastSignalShort := false
    lastSignalBar := bar_index

if shortSignal
    lastSignalShort := true
    lastSignalLong := false
    lastSignalBar := bar_index

// ============================================================================
// VISUALIZACION
// ============================================================================

plot(emaFast, "EMA 9", color=bullColor, linewidth=2)
plot(emaSlow, "EMA 21", color=bearColor, linewidth=2)
plot(showEMA200 ? ema200 : na, "EMA 200", color=color.new(color.white, 60), linewidth=1)

plotshape(showSignals and longSignal, title="LONG", style=shape.triangleup, location=location.belowbar, color=bullColor, size=size.normal)
plotshape(showSignals and shortSignal, title="SHORT", style=shape.triangledown, location=location.abovebar, color=bearColor, size=size.normal)

// ============================================================================
// LABELS SL/TP - USA OB PARA SL + SPREAD
// ============================================================================

if showSignals and showLabels and longSignal
    slBase = useOBforSL ? getNearestBullOBBottom() : close - (atrValue * atrMult)
    slPrice = slBase - totalSpreadBuffer
    riskAmount = close - slPrice
    tpPrice = close + (riskAmount * rrRatio)
    slPips = (close - slPrice) * 100
    tpPips = (tpPrice - close) * 100
    slType = useOBforSL and isInBullOB ? "OB" : "ATR"
    
    label.new(bar_index, low, 
      "LONG " + str.tostring(confLong) + "/7\n" +
      "SL[" + slType + "]: " + str.tostring(slPrice, "#.###") + " (" + str.tostring(slPips, "#.#") + "p)\n" +
      "TP: " + str.tostring(tpPrice, "#.###") + " (" + str.tostring(tpPips, "#.#") + "p)", 
      style=label.style_label_up, color=color.new(bullColor, 10), textcolor=color.white, size=size.small)

if showSignals and showLabels and shortSignal
    slBase = useOBforSL ? getNearestBearOBTop() : close + (atrValue * atrMult)
    slPrice = slBase + totalSpreadBuffer
    riskAmount = slPrice - close
    tpPrice = close - (riskAmount * rrRatio)
    slPips = (slPrice - close) * 100
    tpPips = (close - tpPrice) * 100
    slType = useOBforSL and isInBearOB ? "OB" : "ATR"
    
    label.new(bar_index, high, 
      "SHORT " + str.tostring(confShort) + "/7\n" +
      "SL[" + slType + "]: " + str.tostring(slPrice, "#.###") + " (" + str.tostring(slPips, "#.#") + "p)\n" +
      "TP: " + str.tostring(tpPrice, "#.###") + " (" + str.tostring(tpPips, "#.#") + "p)", 
      style=label.style_label_down, color=color.new(bearColor, 10), textcolor=color.white, size=size.small)

// ============================================================================
// PANEL INFORMATIVO
// ============================================================================

var table panel = table.new(position.top_right, 2, 12, bgcolor=color.new(color.black, 85), border_width=1, border_color=color.gray)

if showPanel and barstate.islast
    trendTxt = trendUp and htfTrendUp ? "BULL" : trendDown and htfTrendDown ? "BEAR" : "MIX"
    trendCol = trendUp and htfTrendUp ? bullColor : trendDown and htfTrendDown ? bearColor : color.yellow
    
    kzTxt = inTokyoKZ and showTokyoKZ ? "TOKYO" : inLondonKZ ? "LONDON" : inNYKZ ? "NY" : inNYOverlap ? "NY-OVL" : "-"
    kzCol = inAnyKZ ? color.lime : color.gray
    
    zonaTxt = inDiscount ? "DISCOUNT" : "PREMIUM"
    zonaCol = inDiscount ? bullColor : bearColor
    
    atrPips = atrValue * 100
    
    table.cell(panel, 0, 0, "SMS-JPY v3", text_color=color.rgb(255, 193, 7), text_size=size.small)
    table.cell(panel, 1, 0, "", text_size=size.small)
    
    table.cell(panel, 0, 1, "Trend", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 1, trendTxt, text_color=trendCol, text_size=size.tiny)
    
    table.cell(panel, 0, 2, "KZ", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 2, kzTxt, text_color=kzCol, text_size=size.tiny)
    
    table.cell(panel, 0, 3, "Zona", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 3, zonaTxt, text_color=zonaCol, text_size=size.tiny)
    
    table.cell(panel, 0, 4, "ATR", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 4, str.tostring(atrPips, "#.#") + " pips", text_color=color.orange, text_size=size.tiny)
    
    table.cell(panel, 0, 5, "OB", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 5, isInBullOB ? "BULL" : isInBearOB ? "BEAR" : "-", text_color=isInBullOB ? bullColor : isInBearOB ? bearColor : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 6, "L-Conf", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 6, str.tostring(confLong) + "/7", text_color=confLong >= minConfluence ? bullColor : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 7, "S-Conf", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 7, str.tostring(confShort) + "/7", text_color=confShort >= minConfluence ? bearColor : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 8, "JST", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 8, str.tostring(jstHour) + ":00", text_color=inTokyoKZ ? color.rgb(255, 193, 7) : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 9, "Spread", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 9, str.tostring(spreadPips, "#.#") + " pips", text_color=color.orange, text_size=size.tiny)
    
    table.cell(panel, 0, 10, "SL Mode", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 10, useOBforSL ? "OB+Spread" : "ATR", text_color=color.aqua, text_size=size.tiny)
    
    table.cell(panel, 0, 11, "Alertas", text_color=color.white, text_size=size.tiny)
    table.cell(panel, 1, 11, enableAlerts ? "ON" : "OFF", text_color=enableAlerts ? color.lime : color.gray, text_size=size.tiny)

// ============================================================================
// ALERTAS DINAMICAS - NUEVO: Mensajes detallados sincronizados con labels
// ============================================================================

// Calcular SL y TP para alertas
slLongCalc = useOBforSL ? getNearestBullOBBottom() - totalSpreadBuffer : close - (atrValue * atrMult) - totalSpreadBuffer
tpLongCalc = close + ((close - slLongCalc) * rrRatio)
slShortCalc = useOBforSL ? getNearestBearOBTop() + totalSpreadBuffer : close + (atrValue * atrMult) + totalSpreadBuffer
tpShortCalc = close - ((slShortCalc - close) * rrRatio)

slLongPips = (close - slLongCalc) * 100
tpLongPips = (tpLongCalc - close) * 100
slShortPips = (slShortCalc - close) * 100
tpShortPips = (close - tpShortCalc) * 100
atrPipsAlert = atrValue * 100

// Mensajes de alerta completos
longMessage = "üü¢ LONG USDJPY\n" +
     "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
     "üìç Entrada: " + str.tostring(close, "#.###") + "\n" +
     "üõë SL: " + str.tostring(slLongCalc, "#.###") + " (" + str.tostring(slLongPips, "#.#") + " pips)\n" +
     "üéØ TP: " + str.tostring(tpLongCalc, "#.###") + " (" + str.tostring(tpLongPips, "#.#") + " pips)\n" +
     "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
     "üìä Confluencias: " + str.tostring(confLong) + "/7\n" +
     "‚è∞ Kill Zone: " + kzName + "\n" +
     "üìà Tendencia: " + trendName + "\n" +
     "üéöÔ∏è Zona: " + zonaName + "\n" +
     "üìê ATR: " + str.tostring(atrPipsAlert, "#.#") + " pips"

shortMessage = "üî¥ SHORT USDJPY\n" +
     "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
     "üìç Entrada: " + str.tostring(close, "#.###") + "\n" +
     "üõë SL: " + str.tostring(slShortCalc, "#.###") + " (" + str.tostring(slShortPips, "#.#") + " pips)\n" +
     "üéØ TP: " + str.tostring(tpShortCalc, "#.###") + " (" + str.tostring(tpShortPips, "#.#") + " pips)\n" +
     "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
     "üìä Confluencias: " + str.tostring(confShort) + "/7\n" +
     "‚è∞ Kill Zone: " + kzName + "\n" +
     "üìà Tendencia: " + trendName + "\n" +
     "üéöÔ∏è Zona: " + zonaName + "\n" +
     "üìê ATR: " + str.tostring(atrPipsAlert, "#.#") + " pips"

// CORREGIDO: Alertas SOLO cuando hay senal visible (longSignal/shortSignal ya incluyen barstate.isconfirmed)
if enableAlerts and longSignal
    alert(longMessage, alert.freq_once_per_bar_close)

if enableAlerts and shortSignal
    alert(shortMessage, alert.freq_once_per_bar_close)

// CORREGIDO: Alertas CHoCH solo cuando hay label visible
if enableAlerts and alertOnCHoCH and choch_bull_confirmed
    alert("‚ö° CHoCH ALCISTA USDJPY @ " + str.tostring(close, "#.###") + " | KZ: " + kzName, alert.freq_once_per_bar_close)

if enableAlerts and alertOnCHoCH and choch_bear_confirmed
    alert("‚ö° CHoCH BAJISTA USDJPY @ " + str.tostring(close, "#.###") + " | KZ: " + kzName, alert.freq_once_per_bar_close)

// CORREGIDO: Alertas BOS solo cuando hay label visible
if enableAlerts and alertOnBOS and bos_bull_confirmed
    alert("üìà BOS ALCISTA USDJPY @ " + str.tostring(close, "#.###") + " | KZ: " + kzName, alert.freq_once_per_bar_close)

if enableAlerts and alertOnBOS and bos_bear_confirmed
    alert("üìâ BOS BAJISTA USDJPY @ " + str.tostring(close, "#.###") + " | KZ: " + kzName, alert.freq_once_per_bar_close)

// CORREGIDO: Alertas Sweep solo cuando hay label visible
if enableAlerts and alertOnSweeps and showSweepHighLabel
    alert("üíß SWEEP HIGHS USDJPY @ " + str.tostring(close, "#.###") + " - Posible SHORT | KZ: " + kzName, alert.freq_once_per_bar_close)

if enableAlerts and alertOnSweeps and showSweepLowLabel
    alert("üíß SWEEP LOWS USDJPY @ " + str.tostring(close, "#.###") + " - Posible LONG | KZ: " + kzName, alert.freq_once_per_bar_close)

// ============================================================================
// ALERTCONDITIONS - CORREGIDO: Sincronizados con labels
// ============================================================================

alertcondition(longSignal, title="LONG Signal", message="LONG USDJPY")
alertcondition(shortSignal, title="SHORT Signal", message="SHORT USDJPY")
alertcondition(choch_bull_confirmed, title="CHoCH BULL", message="CHoCH Alcista USDJPY")
alertcondition(choch_bear_confirmed, title="CHoCH BEAR", message="CHoCH Bajista USDJPY")
alertcondition(bos_bull_confirmed, title="BOS BULL", message="BOS Alcista USDJPY")
alertcondition(bos_bear_confirmed, title="BOS BEAR", message="BOS Bajista USDJPY")
alertcondition(showSweepHighLabel, title="SWEEP HIGH", message="Sweep Highs USDJPY")
alertcondition(showSweepLowLabel, title="SWEEP LOW", message="Sweep Lows USDJPY")
